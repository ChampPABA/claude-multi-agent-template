# CLAUDE.md

> **Navigation Hub for AI Agents**
> **Template Version:** 1.3.0 - Universal Multi-Agent Template
> **Latest:** TaskMaster Integration - Intelligent task analysis with complexity, dependencies, risk assessment

---

## ğŸ¯ What is This Template?

Universal, framework-agnostic template for AI-assisted development.

**What's Included:**
- âœ… 6 Specialized Agents (integration + 5 domain specialists)
- âœ… Universal Patterns (logging, testing, error-handling, agent selection)
- âœ… Design Foundation (color theory, spacing, typography)
- âœ… **Auto-Generated Best Practices** (from Context7 MCP per project)
- âœ… **3-Level Indexing** (agents auto-discover project context)
- âœ… Domain-Specific Support (add your business logic)

**What's NOT Included:**
- âŒ Framework patterns â†’ Generated dynamically via `/agentsetup`
- âŒ Package managers â†’ Detected by `/agentsetup`
- âŒ Spec frameworks â†’ Optional (OpenSpec, BMAD, SpecKit)

---

## ğŸ“– Quick Navigation

**Design/UI:**
- `/designsetup` - Auto-generate style guide from reference/codebase/AI
- `design-system/STYLE_TOKENS.json` - **NEW!** Lightweight design tokens (~500 tokens) âœ¨
- `design-system/STYLE_GUIDE.md` - Full style guide (17 sections, ~5000 tokens)
- `@/.claude/lib/document-loader.md` - **NEW!** Token-efficient loading patterns âœ¨
- `@/.claude/contexts/design/index.md` (General design principles - fallback)
- `@/.claude/contexts/design/box-thinking.md` (Layout analysis)
- `@/.claude/contexts/patterns/ui-component-consistency.md` (Visual consistency)

**Development:**
- `@/.claude/contexts/patterns/task-classification.md` (Agent selection guide)
- `@/.claude/contexts/patterns/agent-coordination.md` (When to run agents parallel/sequential)
- `@/.claude/contexts/patterns/error-recovery.md` (How agents handle errors & escalate)
- `@/.claude/contexts/patterns/logging.md`
- `@/.claude/contexts/patterns/testing.md`
- `@/.claude/contexts/patterns/task-breakdown.md`
- `@/.claude/contexts/patterns/frontend-component-strategy.md`

**Project Setup:**
- `/designsetup` - **NEW!** Auto-generate style guide (reference â†’ codebase â†’ AI)
- `/psetup` - One-time project setup (detect tech stack, generate best practices)
- `/agentsetup` - Auto-detect tech stack and generate best practices

**Page Planning (UI Tasks):**
- `/pageplan @prd.md @brief.md` - **NEW!** Generate page structure & content plan for UI tasks
- Output: `.changes/{id}/page-plan.md` (component reuse, content draft, asset checklist)
- Used by: uxui-frontend agent (auto-reads in STEP 0.5)

**OpenSpec Multi-Agent Workflow:**
- `/csetup {change-id}` - Setup change context (analyze tasks, generate workflow)
- `/cdev {change-id}` - Start/continue multi-agent development
- `/cview {change-id}` - View detailed progress for a change
- `/cstatus {change-id}` - Quick progress status for a change

**Best Practices (Dynamic):**
- `.claude/contexts/domain/{project}/best-practices/` (generated by `/agentsetup`)
- Framework-specific guidelines from Context7 MCP

**Indexing (3 Levels):**
- Level 1: `.claude/contexts/domain/index.md` (Project Registry)
- Level 2: `.claude/contexts/domain/{project}/README.md` (Project Overview)
- Level 3: `.claude/contexts/domain/{project}/best-practices/index.md` (Best Practices Registry)

**ğŸ†• Implementation Logic (v1.1.0):**
- `@/.claude/lib/README.md` - Implementation logic overview
- `@/.claude/lib/agent-executor.md` - Agent retry & escalation logic (used by /cdev)
- `@/.claude/lib/tdd-classifier.md` - TDD classification logic (used by /csetup)
- `@/.claude/lib/flags-updater.md` - ğŸ†• Progress tracking protocol (Main Claude updates flags.json)
- `@/.claude/lib/agent-router.md` - ğŸ†• Mandatory agent routing rules (enforce delegation)
- `@/.claude/contexts/patterns/agent-discovery.md` - Shared agent discovery flow

---

## ğŸ“š Best Practices System

### How It Works:

1. **Run `/agentsetup`** to detect tech stack and generate best practices
2. **Context7 queries** latest framework docs (React, Next.js, Prisma, etc.)
3. **Best practices files** created in `domain/{project}/best-practices/`
4. **Agents auto-discover** project via 3-level indexing
5. **Code quality** enforced by framework-specific patterns

### Generated Files:

```
.claude/contexts/domain/
â”œâ”€â”€ index.md                              # Level 1 - Project Registry
â””â”€â”€ {project}/
    â”œâ”€â”€ README.md                         # Level 2 - Project Overview
    â”œâ”€â”€ tech-stack.md                     # Tech details
    â””â”€â”€ best-practices/
        â”œâ”€â”€ index.md                      # Level 3 - Best Practices Registry
        â”œâ”€â”€ react-18.md                   # âœ… DO's, âŒ DON'Ts, ğŸ¯ Checklist
        â”œâ”€â”€ nextjs-15.md
        â”œâ”€â”€ prisma-6.md
        â””â”€â”€ vitest-2.md
```

### Agent Discovery Flow:

**Every agent follows this sequence (STEP 0):**

```
1. Read: domain/index.md â†’ Get current project name
2. Read: domain/{project}/README.md â†’ Get tech stack
3. Read: domain/{project}/best-practices/index.md â†’ Get relevant files
4. Read: domain/{project}/best-practices/{files} â†’ Load best practices
5. Report: "âœ… Project Context Loaded"
```

**Example: uxui-frontend agent**
```
âœ… Project Context Loaded

ğŸ“ Project: my-app
ğŸ› ï¸ Stack: Next.js 15, React 18, Prisma 6
ğŸ“š Best Practices Loaded:
   - React 18 âœ“
   - Next.js 15 âœ“

ğŸ¯ Ready to create UI components!
```

---

## ğŸ¨ Design System / Style Guide Generation

### How It Works:

`/designsetup` **auto-detects** your project context and generates a comprehensive style guide.

**Three Smart Paths:**

1. **Path 1: Reference Design** (Priority 1)
   - Detects: `reference/`, `design-reference/`, `designs/` folders
   - Analyzes: HTML files (SingleFile exports), screenshots
   - **Auto-detects design style** (Neo-Brutalism, Minimalist, Modern, etc.)
   - Output: Style guide based on reference design (17 sections, always)

2. **Path 2: Brownfield - Reverse Engineering** (Priority 2)
   - Detects: Existing codebase (> 10 components)
   - Extracts: Colors, spacing, typography, component patterns
   - Output: Style guide reflecting current state + cleanup suggestions

3. **Path 3: Greenfield - AI-Generated** (Priority 3)
   - Detects: Empty project (< 10 components)
   - Asks: Application type (SaaS, Marketing, E-commerce, etc.)
   - Output: Modern, best-practice style guide

### Generated File:

```
design-system/
â””â”€â”€ STYLE_GUIDE.md    â† Comprehensive 17-section guide
```

**All 17 Sections (Complete):**
1. Overview
2. Design Philosophy
3. Color Palette (HEX codes, usage, Tailwind classes)
4. Typography (headings, body, weights)
5. Spacing System (4px/8px grid)
6. Component Styles (Button, Card, Input, Badge, etc.)
7. Shadows & Elevation
8. Animations & Transitions
9. Border Styles
10. Border Radius
11. **Opacity & Transparency** (standalone)
12. **Z-Index Layers** (standalone)
13. **Responsive Breakpoints** (standalone)
14. CSS Variables / Tailwind Theme (Design Tokens in JSON)
15. Layout Patterns
16. Example Component Reference (React + Tailwind code)
17. Additional Sections (Best Practices, Accessibility, Icon System)

### Workflow:

```bash
# Recommended flow:

# 1. Generate style guide FIRST (optional but recommended)
/designsetup

# 2. Setup project (discovers style guide)
/psetup

# 3. Start development (agents use STYLE_GUIDE.md)
/csetup feature-login
/cdev feature-login
```

### Agent Discovery:

**uxui-frontend agent automatically reads:**
1. `design-system/STYLE_GUIDE.md` (if exists) â† **Priority #1**
2. `.claude/contexts/design/*.md` (general principles) â† Fallback

**Why this matters:**
- âœ… Ensures visual consistency (no hardcoded colors, spacing)
- âœ… Prevents duplicate components
- âœ… Enforces accessibility standards
- âœ… Speeds up development (reuse patterns)

---

## âš¡ Context Optimization (v1.2.0 - NEW!)

### The Problem: Token Waste

**Before v1.2.0:**
```
/pageplan     â†’ reads STYLE_GUIDE.md (~5K tokens)
/csetup       â†’ reads STYLE_GUIDE.md (~5K tokens)
/cdev         â†’ sends STYLE_GUIDE.md (~5K tokens)
uxui-frontend â†’ reads STYLE_GUIDE.md (~5K tokens)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Total: ~20K tokens (same content read 4 times!)
```

**After v1.2.0:**
```
/designsetup  â†’ generates STYLE_TOKENS.json (~500 tokens) âœ…
/pageplan     â†’ reads STYLE_TOKENS.json (~500 tokens) âœ…
/csetup       â†’ validates files exist (0 tokens) âœ…
/cdev         â†’ sends reference only (~200 tokens) âœ…
uxui-frontend â†’ reads STYLE_TOKENS.json + selective STYLE_GUIDE (~3.5K) âœ…
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Total: ~4.7K tokens (70% reduction!) âœ¨
```

### The Solution: 3-Tier Loading

**Tier 1: STYLE_TOKENS.json (500 tokens)**
- Lightweight design tokens only
- Used by: /pageplan, /csetup, agents
- Contains: Colors, spacing, typography, shadows

**Tier 2: design-context.md (1K tokens)**
- Project design summary
- File paths and quick reference
- Used by: agents (STEP 0.5)

**Tier 3: STYLE_GUIDE.md (5K tokens)**
- Full reference with examples
- Loaded selectively (specific sections only)
- Used by: agents (when needed)

### Document Loading Pattern

**See:** `@/.claude/lib/document-loader.md` for complete unified pattern

**Commands:**
```typescript
// Pattern A: Planning (/pageplan, /csetup)
Read: STYLE_TOKENS.json (~500 tokens)
Validate: STYLE_GUIDE.md exists (0 tokens)
Total: ~500 tokens

// Pattern B: Execution (/cdev)
Send: Design reference (~200 tokens)
Agent reads: STYLE_TOKENS.json (~500 tokens)
Total: ~700 tokens

// Pattern C: Agent (uxui-frontend)
Read: STYLE_TOKENS.json (~500 tokens)
Read: STYLE_GUIDE sections (~2K tokens, selective)
Total: ~2.5K tokens
```

### Benefits

| Metric | Before | After | Improvement |
|--------|--------|-------|-------------|
| **Token Usage** | ~20K | ~4.7K | 70% reduction |
| **Speed** | Slow | Fast | 3-4x faster |
| **Consistency** | Random | Enforced | 100% |
| **Quality** | Same | Same | Maintained |

### Generated Files

**/designsetup now creates:**
1. `design-system/STYLE_GUIDE.md` (full guide, 17 sections)
2. `design-system/STYLE_TOKENS.json` (tokens only) **NEW!**

**Agents automatically use both!**

---

## ğŸ“‹ Page Planning System

### What is /pageplan?

**Problem it solves:**
- âŒ Before: Agent creates UI without knowing existing components â†’ duplicates Navbar 3 times
- âŒ Before: Agent uses random colors, spacing â†’ Landing page `#0d7276`, Dashboard `#4f46e5` (inconsistent!)
- âŒ Before: Agent uses lorem ipsum â†’ No real content

**Solution: /pageplan command**
- âœ… Searches existing components BEFORE implementing
- âœ… Generates component reuse plan (Navbar âœ… reuse, HeroSection âŒ create)
- âœ… AI drafts real content from PRD (headlines, descriptions)
- âœ… Creates asset checklist for user to prepare (images, icons)

### How It Works:

```bash
# Step 1: OpenSpec generates proposal
User: "Build landing page"
â†’ proposal.md + tasks.md

# Step 2: Generate page plan
User: /pageplan @prd.md @project_brief.md

Main Claude:
1. Reads user-specified files (@prd.md, @brief.md)
2. Reads proposal.md (technical architecture)
3. Reads STYLE_GUIDE.md (visual design)
4. Searches existing components (Glob/Grep)
5. Generates: .changes/{id}/page-plan.md
   - ğŸ”„ Reuse: Navbar, Footer (found)
   - âœ… New: HeroSection, FeatureGrid (create)
   - ğŸ“ Content draft (AI-generated from PRD)
   - ğŸ“¦ Asset checklist (user prepares)

# Step 3: User reviews & prepares
â†’ Edit content draft
â†’ Prepare assets (images, icons)
â†’ Approve page-plan.md

# Step 4: Setup & implement
User: /csetup landing-page
User: /cdev landing-page

â†’ uxui-frontend agent:
  - STEP 0.5: Reads page-plan.md âœ…
  - STEP 3: SKIP component search (page-plan did it!) âš¡
  - Implements: Reuse Navbar, create HeroSection
  - Uses: Real content from page-plan
  - References: Assets user prepared
```

### page-plan.md Structure:

```markdown
# Page Plan: Landing Page

## 1. Component Plan
ğŸ”„ Reuse: Navbar, Footer (found in codebase)
âœ… New Shared: (none)
âœ… New Specific: HeroSection, FeatureGrid, TestimonialCarousel

## 2. Page Structure
<Layout>
  <Navbar /> {/* Reuse */}
  <HeroSection /> {/* New - content below */}
  <FeatureGrid /> {/* New - content below */}
  <Footer /> {/* Reuse */}
</Layout>

## 3. Assets to Prepare (à¸„à¸¸à¸“à¸•à¹‰à¸­à¸‡à¹€à¸•à¸£à¸µà¸¢à¸¡)
- [ ] hero-image.jpg (1920x1080)
- [ ] logo.svg (200x60)
- [ ] feature-icons (3x 24x24 SVG)

## 4. Content Draft (AI-Generated - à¸à¸£à¸¸à¸“à¸² Review & Edit)
**Headline:** "Master TOEIC with AI-Powered Tests"
**Subheadline:** "Experience exam-quality questions..."
**CTA:** "Start Free Test"
...
```

### Benefits:

| Before (No page-plan) | After (With page-plan) |
|----------------------|------------------------|
| âŒ Agent guesses structure | âœ… Clear structure defined |
| âŒ Duplicate components | âœ… Reuse existing components |
| âŒ Inconsistent design | âœ… Sync with STYLE_GUIDE |
| âŒ Lorem ipsum content | âœ… Real content from PRD |
| âŒ Missing assets | âœ… Asset checklist prepared |
| âŒ Agent wastes time searching | âœ… Search done once upfront (25% faster) |

### When to Use:

```
âœ… Use /pageplan for:
- Landing pages
- Dashboards
- Multi-section UI pages
- Any task with multiple components

âŒ Skip /pageplan for:
- Backend API endpoints
- Database schemas
- Simple single-component tasks
- Non-UI work
```

### Integration with STYLE_GUIDE:

```
STYLE_GUIDE.md â†’ Visual design (colors, spacing, shadows)
page-plan.md   â†’ Content structure (sections, components, assets)

uxui-frontend agent combines both:
- Colors from STYLE_GUIDE (#0d7276)
- Content from page-plan ("Master TOEIC...")
- Result: Consistent + Real content
```

---

## ğŸ§  TaskMaster-style Analysis (v1.3.0 - NEW!)

### The Problem: Dumb Task Lists

**Before v1.3.0:**
```
tasks.md (from OpenSpec):
- Create login system
- Build user dashboard
- Add payment integration

/csetup generates phases â†’ Treats all tasks equally
â†’ No complexity analysis
â†’ No dependency detection
â†’ No risk assessment
â†’ No time buffers
â†’ Result: Tasks fail, delays, security issues
```

**After v1.3.0:**
```
tasks.md â†’ TaskMaster Analysis â†’ Intelligent phases.md

Analysis includes:
- Complexity scoring (1-10)
- Dependency graph (blocks/blocked by)
- Risk assessment (LOW/MEDIUM/HIGH)
- Research requirements detection
- Subtask breakdown (if needed)
- Priority ranking (CRITICAL â†’ LOW)
- Time buffer calculation
```

### The Solution: Intelligent Task Analysis

**Inspired by:** [claude-task-master](https://github.com/eyaltoledano/claude-task-master)

**See:** `@/.claude/lib/task-analyzer.md` for complete analysis logic

---

### 6 Analysis Dimensions

#### 1. Complexity Scoring (1-10)

**Factors:**
- Estimated time (> 2 hours = high)
- Security keywords (auth, payment, encryption)
- Multi-step indicators (multiple "and", "then")
- External dependencies (APIs, libraries)

**Levels:**
- 1-3: Simple (CRUD, UI components)
- 4-6: Moderate (Business logic)
- 7-8: Complex (Auth, real-time)
- 9-10: Critical (Security, migrations)

#### 2. Dependency Detection

**Automatic detection:**
- UI depends on backend API âœ…
- Backend depends on database âœ…
- Tests depend on implementation âœ…
- Integration depends on both UI + API âœ…

**Outputs:**
- Blocks: Tasks this task blocks
- Blocked by: Tasks blocking this task
- Parallelizable: Can run in parallel

#### 3. Risk Assessment

**Risk Factors:**
- Complexity score (9-10 = +3 risk)
- Security-critical (+3 risk)
- External dependencies (+1 risk)
- Data migration (+2 risk)

**Mitigation strategies:**
- TDD required (high risk)
- Security checklist
- Time buffer (+50% for HIGH)
- Pair programming

#### 4. Research Requirements

**Auto-detects need for research:**
- New technology (React Query v5 â†’ research)
- Best practices (performance optimization)
- Integration (Stripe setup guide)
- Migration (upgrade strategies)

**Generates research queries:**
```
Task: "Migrate to React Query v5"
â†’ Research Phase 0.1 added (15 min)
  Queries:
  - "React Query v5 migration guide"
  - "Breaking changes from v4 to v5"
```

#### 5. Subtask Breakdown

**When to break down:**
- Complexity >= 7
- Multiple verbs (create + update + delete)
- Time > 90 minutes
- Multiple "and" connectors

**Example:**
```
Task: "Create login system"
â†’ Subtasks:
  1.1: Login form UI (45 min)
  1.2: Form validation (30 min)
  1.3: POST /api/login (30 min)
  1.4: JWT auth (40 min)
  1.5: Integration (20 min)
```

#### 6. Priority Ranking (0-100)

**Scoring factors:**
- Business value (login, checkout = +30)
- Blocks other tasks (+10 per task)
- No blockers (+20)
- Risk level (high = +15)
- Complexity (simple = +10 for quick wins)

**Labels:**
- 80-100: CRITICAL
- 60-79: HIGH
- 40-59: MEDIUM
- 0-39: LOW

---

### Generated Output Example

**Before (Simple phases.md):**
```markdown
## Phase 1: Frontend Mockup
Agent: uxui-frontend
Estimated: 90 min
```

**After (TaskMaster-enhanced):**
```markdown
## ğŸ“Š Task Analysis Summary

Total tasks: 8 â†’ 15 (subtask expansion)
Average complexity: 5.8/10

Priority Distribution:
- ğŸ”´ CRITICAL: 2 (Login, Payment)
- ğŸŸ  HIGH: 3
- ğŸŸ¡ MEDIUM: 2
- ğŸŸ¢ LOW: 1

Risk Assessment:
- ğŸš¨ HIGH: 2 tasks â†’ TDD required
- âš ï¸ MEDIUM: 3 tasks
- âœ… LOW: 3 tasks

Time Estimates:
- Original: 6.5 hours
- Adjusted: 9.2 hours (+41% buffer)

---

## Phase 0.1: Research React Query v5 (Research)

Agent: integration
Time: 15 min

Queries:
- React Query v5 migration guide
- Breaking changes from v4 to v5

---

## Phase 1: Login Form UI

Agent: uxui-frontend
Time: 45 min â†’ 60 min (+33% buffer)

**Task Metadata:**
- Complexity: 6/10 (Moderate)
- Priority: CRITICAL (85/100)
- Risk: MEDIUM
  - Mitigation: TDD required
- Dependencies:
  - Blocks: Phase 3 (Integration)
  - Parallelizable: Phase 2 (API)
- Subtasks:
  - 1.1: Email input component
  - 1.2: Password input component
  - 1.3: Submit button with loading state
```

---

### Benefits

| Metric | Before | After | Improvement |
|--------|--------|-------|-------------|
| **Task Analysis** | Basic | Intelligent | 6 dimensions |
| **Complexity** | Ignored | Scored 1-10 | Risk-aware |
| **Dependencies** | Manual | Auto-detected | Faster planning |
| **Time Estimates** | Optimistic | With buffer | More accurate |
| **Research Phases** | Missing | Auto-added | Informed decisions |
| **Subtasks** | None | Auto-expanded | Clearer workflow |
| **Priority** | Random | Scored 0-100 | Right order |

---

### Workflow

```bash
# 1. OpenSpec generates tasks
User: "Build login system"
â†’ tasks.md

# 2. /csetup analyzes tasks (STEP 3.5 - TaskMaster)
/csetup login-feature

â†’ Analyzing 3 tasks...
â†’ Expanded to 8 subtasks
â†’ 2 research phases added
â†’ Complexity: 5.8/10 average
â†’ Time: 3.5h â†’ 5.2h (+48% buffer)

# 3. Enhanced phases.md generated
â†’ Research phases first
â†’ Implementation phases with metadata
â†’ Dependencies mapped
â†’ Risk mitigation noted

# 4. Execute with /cdev
/cdev login-feature

â†’ Agents see full context:
  - Complexity warnings
  - Risk mitigation
  - Dependency order
  - Time buffers
```

---

## ğŸ¤– Agent System

### How It Works:

**Main Claude analyzes tasks â†’ Invokes specialist agents directly**

```
1. User provides task (e.g., "Build login system")
   â†“
2. Main Claude reads @task-classification.md
   â†“
3. Main Claude selects appropriate agent(s)
   â†“
4. Execute in proper sequence:
   - Phase 1: uxui-frontend (UI with mock data)
   - Phase 2: backend + database (parallel)
   - Phase 2.5: integration (validate contracts)
   - Phase 3: frontend (connect UI to API)
   - Phase 4: test-debug (tests & bug fixes)
```

### Available Agents (6 specialists):

| Agent | Color | When to Use | Phase |
|-------|-------|-------------|-------|
| **integration** | Orange | Validate API contracts before connecting | 2.5 |
| **uxui-frontend** | Blue | Design UI components with mock data | 1 |
| **test-debug** | Red | Run tests and fix bugs (max 3-4 iterations) | 1,3,4 |
| **frontend** | Green | Connect UI to backend APIs | 3 |
| **backend** | Purple | Create API endpoints with validation | 2 |
| **database** | Pink | Design schemas, migrations, complex queries | 2 |

### Usage:

**For any task, Main Claude will:**
1. Read `@/.claude/contexts/patterns/task-classification.md`
2. Determine which agent(s) to use
3. Invoke agents in proper sequence
4. Coordinate between agents

**You can also invoke agents directly:**
```
User: "/agents uxui-frontend"
Main Claude: *Executes uxui-frontend agent directly*
```

---

### ğŸ”’ Main Claude Self-Check Protocol (MANDATORY)

**âš ï¸ CRITICAL: Main Claude MUST complete this checklist BEFORE doing ANY work**

See: `@/.claude/lib/agent-router.md` for complete routing protocol

**Pre-Work Checklist (Run for EVERY user request):**

```markdown
## âœ… Pre-Work Self-Check

[ ] 1. Read user request carefully
       - What are they asking for?
       - What is the end goal?

[ ] 2. Detect work type
       - Is this implementation work? (writing code, creating files)
       - Is this planning/analysis? (reading, explaining, breaking down)

[ ] 3. If IMPLEMENTATION work:
       - Read: @/.claude/contexts/patterns/task-classification.md
       - Which agent should handle this?
         â€¢ UI components â†’ uxui-frontend
         â€¢ API endpoints â†’ backend
         â€¢ Database schemas â†’ database
         â€¢ API integration â†’ frontend
         â€¢ Tests/bugs â†’ test-debug
         â€¢ Contracts â†’ integration

[ ] 4. Can Main Claude do this?
       âœ… YES for: Planning, reading files, explaining, orchestrating workflows
       âŒ NO for: Writing components, creating endpoints, designing schemas

[ ] 5. If MUST delegate:
       - Use Task tool with selected agent
       - Include all necessary context
       - Wait for agent response
       - Update flags.json after completion (if using /cdev)

[ ] 6. Report decision to user
       ```
       ğŸ” Task Analysis:
       - Work type: [type]
       - Requires: [agent] agent
       - Reason: [explanation]

       ğŸš€ Invoking [agent] agent...
       ```
```

**Main Claude's Role:**
- âœ… Orchestrator (plan, coordinate, report)
- âœ… Progress tracker (update flags.json)
- âœ… Analyst (read files, explain code)
- âŒ NOT implementer (no writing code directly)

**If Main Claude skips this self-check for implementation work, it violates system protocol.**

---

### âš ï¸ Agent Pre-Work Requirements

**STEP 0 (ALL agents):** Every agent must discover project context first

**STEP 1-5 (uxui-frontend only):** Design fundamentals checklist

---

#### STEP 0: Project Discovery (ALL Agents)

**Every agent MUST complete this before ANY work:**

```
1. Read: domain/index.md â†’ Get current project name
2. Read: domain/{project}/README.md â†’ Get tech stack summary
3. Read: domain/{project}/best-practices/index.md â†’ Find relevant files
4. Read: domain/{project}/best-practices/{files} â†’ Load best practices
5. Report: "âœ… Project Context Loaded"
```

**STEP 0.5 (uxui-frontend ONLY):**

```
6. Check: design-system/STYLE_GUIDE.md exists?
   - If YES â†’ Read STYLE_GUIDE.md (Priority #1 - project-specific)
   - If NO â†’ Read .claude/contexts/design/*.md (Fallback - general principles)
7. Report: "âœ… Style Guide Loaded" or "âš ï¸ No style guide - using general principles"
```

**Why this matters:**
- STYLE_GUIDE.md = project-specific design system (colors, spacing, components)
- design/*.md = universal design principles (box thinking, color theory)
- Priority: STYLE_GUIDE.md > design/*.md

**Fallback:** If discovery fails, warn user to run `/agentsetup` or `/designsetup`

---

#### STEP 1-5: Design Fundamentals (uxui-frontend only)

**When invoking uxui-frontend agent, Main Claude MUST include these requirements in the Task prompt:**

```
MANDATORY PRE-WORK CHECKLIST (after STEP 0):

Before writing ANY code, you MUST:

1. **Read ALL design contexts:**
   - @/.claude/contexts/design/index.md
   - @/.claude/contexts/design/box-thinking.md
   - @/.claude/contexts/design/color-theory.md
   - @/.claude/contexts/design/spacing.md
   - @/.claude/contexts/patterns/ui-component-consistency.md
   - @/.claude/contexts/patterns/frontend-component-strategy.md

2. **Do Box Thinking Analysis:**
   - Identify all boxes (parent, children, siblings)
   - Document relationships (container, adjacent, nested)
   - Plan space flow using spacing scale (8, 16, 24, 32, 40, 48px)
   - Plan responsive behavior (stack/merge/compress)

3. **Search for Existing Components:**
   - Glob: "**/*{Keyword}*.{tsx,jsx,vue}"
   - Grep: "[similar-pattern]"
   - Decision: Reuse > Compose > Extend > Create New
   - If creating new: Extract design tokens from most similar component

4. **Extract Design Tokens from Reference Component:**
   ```typescript
   const DESIGN_TOKENS = {
     spacing: { padding: '[from reference]', gap: '[from reference]' },
     colors: { bg: '[theme token]', text: '[theme token]', border: '[theme token]' },
     shadows: '[from reference - e.g., shadow-sm]',
     borderRadius: '[from reference - e.g., rounded-md]'
   }
   ```

5. **Report Pre-Implementation Analysis:**
   You MUST provide a detailed report covering steps 1-4 BEFORE writing any code.

CRITICAL RULES:
- âŒ NO hardcoded colors (text-gray-500) â†’ âœ… Use theme tokens (text-foreground/70)
- âŒ NO arbitrary spacing (p-5) â†’ âœ… Use spacing scale (p-4, p-6)
- âŒ NO inconsistent icons (h-5 w-5, opacity-50) â†’ âœ… Match reference (h-4 w-4, text-foreground/70)
- âŒ NO creating duplicate components â†’ âœ… Search and reuse first

If you skip these steps, your work will be rejected.
```

**Why this enforcement matters:**
- Prevents visual inconsistency (mismatched colors, spacing, shadows)
- Ensures component reuse (avoids duplicates)
- Maintains design system integrity
- Saves implementation time

**Example: Build Login System**
```
User: "Build a login system"
Main Claude analyzes â†’ Breaks into phases:
  Phase 1: /agents uxui-frontend (create login form UI)
  Phase 2: /agents backend (create POST /api/login)
          /agents database (create User model) [parallel]
  Phase 2.5: /agents integration (verify contracts)
  Phase 3: /agents frontend (connect form to API)
  Phase 4: /agents test-debug (test everything)
```

---

**ğŸ’¡ Remember:** This template is universal. Use Context7 for framework-specific docs!
