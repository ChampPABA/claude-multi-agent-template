# CLAUDE.md

> **Navigation Hub for AI Agents**
> **Template Version:** 1.1.0 - Universal Multi-Agent Template
> **Latest:** Production-ready with validation enforcement, TDD classification, and retry logic

---

## üéØ What is This Template?

Universal, framework-agnostic template for AI-assisted development.

**What's Included:**
- ‚úÖ 6 Specialized Agents (integration + 5 domain specialists)
- ‚úÖ Universal Patterns (logging, testing, error-handling, agent selection)
- ‚úÖ Design Foundation (color theory, spacing, typography)
- ‚úÖ **Auto-Generated Best Practices** (from Context7 MCP per project)
- ‚úÖ **3-Level Indexing** (agents auto-discover project context)
- ‚úÖ Domain-Specific Support (add your business logic)

**What's NOT Included:**
- ‚ùå Framework patterns ‚Üí Generated dynamically via `/agentsetup`
- ‚ùå Package managers ‚Üí Detected by `/agentsetup`
- ‚ùå Spec frameworks ‚Üí Optional (OpenSpec, BMAD, SpecKit)

---

## üìñ Quick Navigation

**Design/UI:**
- `@/.claude/contexts/design/index.md` (Start here)
- `@/.claude/contexts/design/box-thinking.md` (Layout analysis)
- `@/.claude/contexts/patterns/ui-component-consistency.md` (Visual consistency)

**Development:**
- `@/.claude/contexts/patterns/task-classification.md` (Agent selection guide)
- `@/.claude/contexts/patterns/agent-coordination.md` (When to run agents parallel/sequential)
- `@/.claude/contexts/patterns/error-recovery.md` (How agents handle errors & escalate)
- `@/.claude/contexts/patterns/logging.md`
- `@/.claude/contexts/patterns/testing.md`
- `@/.claude/contexts/patterns/task-breakdown.md`
- `@/.claude/contexts/patterns/frontend-component-strategy.md`

**Project Setup:**
- `/psetup` - One-time project setup (detect tech stack, generate best practices)
- `/agentsetup` - Auto-detect tech stack and generate best practices
- `/designsetup` - Setup project-specific design system from reference website

**OpenSpec Multi-Agent Workflow:**
- `/csetup {change-id}` - Setup change context (analyze tasks, generate workflow)
- `/cdev {change-id}` - Start/continue multi-agent development
- `/cview {change-id}` - View detailed progress for a change
- `/cstatus {change-id}` - Quick progress status for a change

**Best Practices (Dynamic):**
- `.claude/contexts/domain/{project}/best-practices/` (generated by `/agentsetup`)
- Framework-specific guidelines from Context7 MCP

**Indexing (3 Levels):**
- Level 1: `.claude/contexts/domain/index.md` (Project Registry)
- Level 2: `.claude/contexts/domain/{project}/README.md` (Project Overview)
- Level 3: `.claude/contexts/domain/{project}/best-practices/index.md` (Best Practices Registry)

**üÜï Implementation Logic (v1.1.0):**
- `@/.claude/lib/README.md` - Implementation logic overview
- `@/.claude/lib/agent-executor.md` - Agent retry & escalation logic (used by /cdev)
- `@/.claude/lib/tdd-classifier.md` - TDD classification logic (used by /csetup)
- `@/.claude/lib/flags-updater.md` - üÜï Progress tracking protocol (Main Claude updates flags.json)
- `@/.claude/lib/agent-router.md` - üÜï Mandatory agent routing rules (enforce delegation)
- `@/.claude/contexts/patterns/agent-discovery.md` - Shared agent discovery flow

---

## üìö Best Practices System

### How It Works:

1. **Run `/agentsetup`** to detect tech stack and generate best practices
2. **Context7 queries** latest framework docs (React, Next.js, Prisma, etc.)
3. **Best practices files** created in `domain/{project}/best-practices/`
4. **Agents auto-discover** project via 3-level indexing
5. **Code quality** enforced by framework-specific patterns

### Generated Files:

```
.claude/contexts/domain/
‚îú‚îÄ‚îÄ index.md                              # Level 1 - Project Registry
‚îî‚îÄ‚îÄ {project}/
    ‚îú‚îÄ‚îÄ README.md                         # Level 2 - Project Overview
    ‚îú‚îÄ‚îÄ tech-stack.md                     # Tech details
    ‚îî‚îÄ‚îÄ best-practices/
        ‚îú‚îÄ‚îÄ index.md                      # Level 3 - Best Practices Registry
        ‚îú‚îÄ‚îÄ react-18.md                   # ‚úÖ DO's, ‚ùå DON'Ts, üéØ Checklist
        ‚îú‚îÄ‚îÄ nextjs-15.md
        ‚îú‚îÄ‚îÄ prisma-6.md
        ‚îî‚îÄ‚îÄ vitest-2.md
```

### Agent Discovery Flow:

**Every agent follows this sequence (STEP 0):**

```
1. Read: domain/index.md ‚Üí Get current project name
2. Read: domain/{project}/README.md ‚Üí Get tech stack
3. Read: domain/{project}/best-practices/index.md ‚Üí Get relevant files
4. Read: domain/{project}/best-practices/{files} ‚Üí Load best practices
5. Report: "‚úÖ Project Context Loaded"
```

**Example: uxui-frontend agent**
```
‚úÖ Project Context Loaded

üìÅ Project: my-app
üõ†Ô∏è Stack: Next.js 15, React 18, Prisma 6
üìö Best Practices Loaded:
   - React 18 ‚úì
   - Next.js 15 ‚úì

üéØ Ready to create UI components!
```

---

## üé® Design System Setup

### How It Works:

**Purpose:** Extract design tokens from reference websites to ensure pixel-perfect UI consistency.

**Workflow:**

```
1. User captures reference website:
   - Install SingleFile Extension
   - Save page ‚Üí reference/{sitename}.html
   - (Optional) Screenshot ‚Üí reference/{sitename}.png

2. Run: /designsetup @reference/
   ‚Üì
3. Agent extracts design system:
   - Colors (exact hex values)
   - Typography (fonts, sizes, weights)
   - Spacing (base unit + scale)
   - Shadows, border radius, components
   ‚Üì
4. Generates: domain/{project}/STYLE_GUIDE.md
   ‚Üì
5. uxui-frontend agent auto-loads STYLE_GUIDE
   ‚Üì
6. All UI components follow design system automatically
```

### Generated Files:

```
.claude/contexts/domain/{project}/
‚îú‚îÄ‚îÄ README.md
‚îú‚îÄ‚îÄ tech-stack.md
‚îú‚îÄ‚îÄ best-practices/
‚îú‚îÄ‚îÄ STYLE_GUIDE.md                    # ‚Üê Design system
‚îú‚îÄ‚îÄ reference.html                    # ‚Üê Source HTML
‚îî‚îÄ‚îÄ reference-screenshot.png          # ‚Üê Visual reference (optional)
```

### Design System Priority:

**When uxui-frontend creates components:**

```
Priority order:
1. STYLE_GUIDE.md (if exists)          ‚Üê Project-specific design
2. Existing components (brownfield)    ‚Üê Extract from code
3. Foundation contexts (fallback)      ‚Üê Generic defaults
```

### When to Use:

‚úÖ **Greenfield projects** with design reference (Linear, Stripe, etc.)
‚úÖ **Consistency critical** (50+ components, need single source of truth)
‚úÖ **Team projects** (shared understanding of design)

‚ö†Ô∏è **Optional for:**
- Quick prototypes
- Brownfield with established patterns
- Projects using component libraries (shadcn/ui, etc.)

### Example:

```bash
# Clone Linear.app design
/designsetup @reference/

# Result:
‚úÖ STYLE_GUIDE.md created
   - Primary: #6366f1 (Indigo)
   - Font: Inter
   - Spacing: 8px base unit
   - 15 component patterns documented

# Now build UI:
/csetup feature-dashboard
/cdev feature-dashboard

# uxui-frontend uses STYLE_GUIDE automatically
# ‚Üí All components: #6366f1 color, 8px spacing, Inter font
# ‚Üí 100% consistent!
```

---

## ü§ñ Agent System

### How It Works:

**Main Claude analyzes tasks ‚Üí Invokes specialist agents directly**

```
1. User provides task (e.g., "Build login system")
   ‚Üì
2. Main Claude reads @task-classification.md
   ‚Üì
3. Main Claude selects appropriate agent(s)
   ‚Üì
4. Execute in proper sequence:
   - Phase 1: uxui-frontend (UI with mock data)
   - Phase 2: backend + database (parallel)
   - Phase 2.5: integration (validate contracts)
   - Phase 3: frontend (connect UI to API)
   - Phase 4: test-debug (tests & bug fixes)
```

### Available Agents (6 specialists):

| Agent | Color | When to Use | Phase |
|-------|-------|-------------|-------|
| **integration** | Orange | Validate API contracts before connecting | 2.5 |
| **uxui-frontend** | Blue | Design UI components with mock data | 1 |
| **test-debug** | Red | Run tests and fix bugs (max 3-4 iterations) | 1,3,4 |
| **frontend** | Green | Connect UI to backend APIs | 3 |
| **backend** | Purple | Create API endpoints with validation | 2 |
| **database** | Pink | Design schemas, migrations, complex queries | 2 |

### Usage:

**For any task, Main Claude will:**
1. Read `@/.claude/contexts/patterns/task-classification.md`
2. Determine which agent(s) to use
3. Invoke agents in proper sequence
4. Coordinate between agents

**You can also invoke agents directly:**
```
User: "/agents uxui-frontend"
Main Claude: *Executes uxui-frontend agent directly*
```

---

### üîí Main Claude Self-Check Protocol (MANDATORY)

**‚ö†Ô∏è CRITICAL: Main Claude MUST complete this checklist BEFORE doing ANY work**

See: `@/.claude/lib/agent-router.md` for complete routing protocol

**Pre-Work Checklist (Run for EVERY user request):**

```markdown
## ‚úÖ Pre-Work Self-Check

[ ] 1. Read user request carefully
       - What are they asking for?
       - What is the end goal?

[ ] 2. Detect work type
       - Is this implementation work? (writing code, creating files)
       - Is this planning/analysis? (reading, explaining, breaking down)

[ ] 3. If IMPLEMENTATION work:
       - Read: @/.claude/contexts/patterns/task-classification.md
       - Which agent should handle this?
         ‚Ä¢ UI components ‚Üí uxui-frontend
         ‚Ä¢ API endpoints ‚Üí backend
         ‚Ä¢ Database schemas ‚Üí database
         ‚Ä¢ API integration ‚Üí frontend
         ‚Ä¢ Tests/bugs ‚Üí test-debug
         ‚Ä¢ Contracts ‚Üí integration

[ ] 4. Can Main Claude do this?
       ‚úÖ YES for: Planning, reading files, explaining, orchestrating workflows
       ‚ùå NO for: Writing components, creating endpoints, designing schemas

[ ] 5. If MUST delegate:
       - Use Task tool with selected agent
       - Include all necessary context
       - Wait for agent response
       - Update flags.json after completion (if using /cdev)

[ ] 6. Report decision to user
       ```
       üîç Task Analysis:
       - Work type: [type]
       - Requires: [agent] agent
       - Reason: [explanation]

       üöÄ Invoking [agent] agent...
       ```
```

**Main Claude's Role:**
- ‚úÖ Orchestrator (plan, coordinate, report)
- ‚úÖ Progress tracker (update flags.json)
- ‚úÖ Analyst (read files, explain code)
- ‚ùå NOT implementer (no writing code directly)

**If Main Claude skips this self-check for implementation work, it violates system protocol.**

---

### ‚ö†Ô∏è Agent Pre-Work Requirements

**STEP 0 (ALL agents):** Every agent must discover project context first

**STEP 1-5 (uxui-frontend only):** Design fundamentals checklist

---

#### STEP 0: Project Discovery (ALL Agents)

**Every agent MUST complete this before ANY work:**

```
1. Read: domain/index.md ‚Üí Get current project name

2. Read: domain/{project}/README.md ‚Üí Get tech stack summary

3. (uxui-frontend only) Check for Design System:

   Path: domain/{project}/STYLE_GUIDE.md

   If exists:
     a) Check for visual reference:
        - Look for: domain/{project}/reference-screenshot.png
        - If found: View screenshot FIRST (get visual context)

     b) Read STYLE_GUIDE.md (get exact values)

     c) Report design system loaded:
        """
        üé® Design System: ‚úì Configured
        üì∏ Visual Reference: ‚úì Available / ‚úó Not provided

        Design Characteristics:
        - Primary Color: {hex}
        - Base Spacing: {value}px
        - Font: {family}
        - Style: {aesthetic description}
        """

   If NOT exists:
     ‚Üí Report: "‚ö†Ô∏è No STYLE_GUIDE.md - Using fallback methods"
     ‚Üí Will use: Existing components OR foundation contexts

4. Read: domain/{project}/best-practices/index.md ‚Üí Find relevant files

5. Read: domain/{project}/best-practices/{files} ‚Üí Load best practices

6. Report: "‚úÖ Project Context Loaded"
```

**Fallback:** If discovery fails, warn user to run `/agentsetup`

---

#### STEP 1-5: Design Fundamentals (uxui-frontend only)

**When invoking uxui-frontend agent, Main Claude MUST include these requirements in the Task prompt:**

```
MANDATORY PRE-WORK CHECKLIST (after STEP 0):

Before writing ANY code, you MUST:

1. **Read ALL design contexts:**
   - @/.claude/contexts/design/index.md
   - @/.claude/contexts/design/box-thinking.md
   - @/.claude/contexts/design/color-theory.md
   - @/.claude/contexts/design/spacing.md
   - @/.claude/contexts/patterns/ui-component-consistency.md
   - @/.claude/contexts/patterns/frontend-component-strategy.md

2. **Do Box Thinking Analysis:**
   - Identify all boxes (parent, children, siblings)
   - Document relationships (container, adjacent, nested)
   - Plan space flow using spacing scale (8, 16, 24, 32, 40, 48px)
   - Plan responsive behavior (stack/merge/compress)

3. **Search for Existing Components:**
   - Glob: "**/*{Keyword}*.{tsx,jsx,vue}"
   - Grep: "[similar-pattern]"
   - Decision: Reuse > Compose > Extend > Create New
   - If creating new: Extract design tokens from most similar component

4. **Extract Design Tokens:**

   **Priority order:**

   **a) From STYLE_GUIDE.md (if exists)** ‚Üê BEST
      - Read exact values from STYLE_GUIDE.md
      - Use documented colors, spacing, fonts
      - No searching needed, guaranteed consistency
      - Example:
        ```typescript
        // From STYLE_GUIDE.md:
        // Primary: #6366f1, Spacing base: 8px
        const DESIGN_TOKENS = {
          colors: { primary: '#6366f1', bg: 'white' },
          spacing: { base: 8, sm: 16, md: 24 },
          borderRadius: 'rounded-md'
        }
        ```

   **b) From Existing Components (if no STYLE_GUIDE)** ‚Üê FALLBACK
      - Glob: "**/*{Keyword}*.{tsx,jsx,vue}"
      - Grep: "[similar-pattern]"
      - Read and extract tokens from similar component
      - If multiple found with different values, ask user
      - Example:
        ```typescript
        // From Button.tsx:
        const DESIGN_TOKENS = {
          spacing: { padding: 'px-4 py-2', gap: 'gap-2' },
          colors: { bg: 'bg-[#6366f1]', text: 'text-white' },
          shadows: 'shadow-sm',
          borderRadius: 'rounded-md'
        }
        ```

   **c) From Foundation Contexts (last resort)** ‚Üê DEFAULT
      - Use generic design contexts (spacing.md, color-theory.md)
      - Default modern style (#6366f1, 8px spacing)
      - Warn user: No project-specific design

5. **Report Pre-Implementation Analysis:**
   You MUST provide a detailed report covering steps 1-4 BEFORE writing any code.

CRITICAL RULES:
- ‚ùå NO hardcoded colors (text-gray-500) ‚Üí ‚úÖ Use theme tokens (text-foreground/70)
- ‚ùå NO arbitrary spacing (p-5) ‚Üí ‚úÖ Use spacing scale (p-4, p-6)
- ‚ùå NO inconsistent icons (h-5 w-5, opacity-50) ‚Üí ‚úÖ Match reference (h-4 w-4, text-foreground/70)
- ‚ùå NO creating duplicate components ‚Üí ‚úÖ Search and reuse first

If you skip these steps, your work will be rejected.
```

**Why this enforcement matters:**
- Prevents visual inconsistency (mismatched colors, spacing, shadows)
- Ensures component reuse (avoids duplicates)
- Maintains design system integrity
- Saves implementation time

**Example: Build Login System**
```
User: "Build a login system"
Main Claude analyzes ‚Üí Breaks into phases:
  Phase 1: /agents uxui-frontend (create login form UI)
  Phase 2: /agents backend (create POST /api/login)
          /agents database (create User model) [parallel]
  Phase 2.5: /agents integration (verify contracts)
  Phase 3: /agents frontend (connect form to API)
  Phase 4: /agents test-debug (test everything)
```

---

**üí° Remember:** This template is universal. Use Context7 for framework-specific docs!
